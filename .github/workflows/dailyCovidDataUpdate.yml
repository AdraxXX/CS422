name: "Daily Covid Data Pull"
env:
    API_KEY: ${{ secrets.COVIDAPIKEY }}
on:
  workflow_dispatch:
  schedule:
  - cron: "0 10 * * *"

jobs:
  stale:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
      - uses: jannekem/run-python-script-action@v1
        with:
          script: |
            import os
            import sys
            import json
            from urllib.request import urlopen

            apiKey = os.environ['API_KEY'];
            currentUSURL = 'https://api.covidactnow.org/v2/states.json?apiKey=' + apiKey
            historicalUSURL = 'https://api.covidactnow.org/v2/states.timeseries.json?apiKey=' + apiKey
            currentAllStates = 'https://api.covidactnow.org/v2/counties.json?apiKey=' + apiKey
            historicalAllStates = 'https://api.covidactnow.org/v2/counties.timeseries.json?apiKey=' + apiKey

            historicalUSResponse = urlopen(historicalUSURL)
            currentUSResponse = urlopen(currentUSURL)
            historicalAllStatesResponse = urlopen(historicalAllStates)
            currentAllStatesResponse = urlopen(currentAllStates)

            dataHistoricalUSJSON = json.loads(historicalUSResponse.read())
            dataCurrentUSJSON = json.loads(currentUSResponse.read())
            dataHistoricalAllStatesJSON = json.loads(historicalAllStatesResponse.read())
            dataCurrentAllStatesJSON = json.loads(currentAllStatesResponse.read())

            updateFile = open("covidData.js", "w")

            newHistoricalUSData = 'let historicalUSData = ' + json.dumps(dataHistoricalUSJSON, indent=4, separators=(", ", " : "))
            newCurrentUSData = 'let currentUSData = ' + json.dumps(dataCurrentUSJSON, indent=4, separators=(", ", " : "))
            newHistoricalAllStatesData = 'let historicalAllStatesData = ' + json.dumps(dataHistoricalAllStatesJSON, indent=4, separators=(", ", " : "))
            newCurrentAllStatesData = 'let currentAllStatesData = ' + json.dumps(dataCurrentAllStatesJSON, indent=4, separators=(", ", " : "))

            updateFile.write(newHistoricalUSData  + '\n' + newCurrentUSData + '\n' + newHistoricalAllStatesData  + '\n' + newCurrentAllStatesData)
            updateFile.close()
      - name: Update resources
        uses: test-room-7/action-update-file@v1
        with:
            branch: main
            file-path: docs/data/covidData.js
            commit-msg: Daily Covid Data Pull
            github-token: ${{ secrets.GITHUB_TOKEN }}
